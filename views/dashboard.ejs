<%- include('./partials/header') %>

<div class="container">
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <% if (isAdmin) { %>
      <span class="badge badge-primary">Admin</span>
    <% } %>
    <p class="lead">Welcome, <%= user.name %></p>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <a href="/tickets/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Create New Ticket
      </a>
    </div>
    <div class="col-md-6">
      <div class="form-group">
        <select id="ticketFilter" class="form-control">
          <option value="all">All Tickets</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Your Tickets</h3>
    </div>
    <div class="card-body">
      <% if (tickets.length > 0) { %>
        <div class="ticket-list">
          <% tickets.forEach(ticket => { %>
            <div class="ticket" data-status="<%= ticket.status %>">
              <div class="ticket-info">
                <h4>
                  <a href="/tickets/<%= ticket._id %>"><%= ticket.title %></a>
                </h4>
                <div class="meta">
                  <span class="status status-<%= ticket.status.toLowerCase().replace(/\s+/g, '-') %>">
                    <%= ticket.status %>
                  </span>
                  <span class="category"><%= ticket.category %></span>
                  <span class="priority">Priority: <%= ticket.priority %></span>
                </div>
                <% if (isAdmin && ticket.user) { %>
                  <small>Created by: <%= ticket.user.name %></small>
                <% } %>
                <p class="dates">
                  Created: <%= new Date(ticket.createdAt).toLocaleDateString() %>
                  <% if (ticket.updatedAt && ticket.updatedAt > ticket.createdAt) { %>
                    | Updated: <%= new Date(ticket.updatedAt).toLocaleDateString() %>
                  <% } %>
                </p>
              </div>
              <div class="actions">
                <a href="/tickets/<%= ticket._id %>" class="btn btn-primary">View</a>
                <% if (isAdmin) { %>
                  <form action="/admin/tickets/<%= ticket._id %>/status?_method=PUT" method="POST" class="d-inline">
                    <select name="status" class="form-control form-control-sm status-select">
                      <option value="Open" <%= ticket.status === 'Open' ? 'selected' : '' %>>Open</option>
                      <option value="In Progress" <%= ticket.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
                      <option value="Resolved" <%= ticket.status === 'Resolved' ? 'selected' : '' %>>Resolved</option>
                      <option value="Closed" <%= ticket.status === 'Closed' ? 'selected' : '' %>>Closed</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-success">Update</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="no-tickets">
          <p>No tickets found.</p>
          <a href="/tickets/create" class="btn btn-primary">Create your first ticket</a>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
  // Filter tickets by status
  document.getElementById('ticketFilter').addEventListener('change', function() {
    const selectedStatus = this.value;
    const tickets = document.querySelectorAll('.ticket');
    
    tickets.forEach(ticket => {
      if (selectedStatus === 'all' || ticket.dataset.status === selectedStatus) {
        ticket.style.display = 'flex';
      } else {
        ticket.style.display = 'none';
      }
    });
  });
</script>

<%- include('./partials/footer') %>